<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงเวลาปฏิบัติหน้าที่ v2 - ครูโรงเรียนปากช่อง</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* --- Custom CSS --- */
        body {
            background-color: #f8f9fa; /* Light gray background */
            font-family: 'Sarabun', sans-serif; /* Thai font */
        }
        #schoolLogo { max-height: 80px; width: auto; border-radius: 8px; }
        #clock { font-size: 1.1rem; font-weight: bold; }
        #teacherInfo { transition: all 0.3s ease-in-out; }
        .teacher-photo { width: 120px; height: 120px; object-fit: cover; border-radius: 50%; border: 3px solid #dee2e6; }
        .signature-pad-container { position: relative; width: 100%; height: 180px; background-color: #ffffff; cursor: crosshair; border: 1px solid #ced4da; border-radius: 0.375rem; }
        #signatureCanvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-radius: 0.375rem; }
        #videoFeed { width: 100%; height: auto; max-height: 240px; display: block; background-color: #343a40; }
        .captured-photo { max-height: 240px; display: block; margin-left: auto; margin-right: auto; background-color: #e9ecef; }
        #statusMessage .alert { margin-bottom: 0; }
        .spinner-border { width: 1rem; height: 1rem; border-width: .2em; }
        .form-label { margin-bottom: 0.5rem; }
        .btn-group-camera button { margin: 0 5px; }
        .form-section-hidden { display: none; } /* Class to initially hide sections */

        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .teacher-photo { max-width: 100px; height: 100px; margin-bottom: 1rem; }
            #videoFeed, .captured-photo { max-height: 200px; }
            .signature-pad-container { height: 150px; }
        }
        /* Style for required fields */
        .required-field::after { content: " *"; color: red; }

        /* SweetAlert custom styling (optional) */
        .swal2-popup { font-family: 'Sarabun', sans-serif !important; }
        .swal2-title { font-size: 1.5rem !important; }
        .swal2-html-container { text-align: left !important; margin-top: 1rem !important; }
        .swal2-image { max-width: 100px; height: 100px; border-radius: 50%; margin: 10px auto !important; }

    </style>
</head>
<body>

    <div class="container mt-4 mb-5">
        <div class="card shadow-sm border-primary">
            <div class="card-header text-center bg-primary text-white p-3">
                <img src="YOUR_SCHOOL_LOGO_URL" alt="โลโก้โรงเรียนปากช่อง" id="schoolLogo" class="mb-2 img-fluid"> <h4 class="mb-1 mt-2">โรงเรียนปากช่อง</h4>
                <p class="mb-0 small">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษานครราชสีมา</p>
            </div>
            <div class="card-body p-lg-4 p-3">
                <div id="clock" class="alert alert-info text-center shadow-sm" role="alert">
                    <i class="fas fa-clock me-2"></i> กำลังโหลดเวลา...
                </div>

                <form id="checkinForm" novalidate>
                    <div class="mb-3">
                        <label for="teacherId" class="form-label fw-bold required-field"><i class="fas fa-id-card me-2 text-primary"></i>รหัสครูผู้สอน (4 หลัก)</label>
                        <input type="text" class="form-control" id="teacherId" name="teacherId" required placeholder="กรอกรหัส 4 หลัก" inputmode="numeric" pattern="\d{4}" maxlength="4" oninput="this.value=this.value.slice(0,4);">
                         <div id="teacherLookupStatus" class="form-text mt-1"></div>
                    </div>

                    <div id="mainFormSections" class="form-section-hidden">

                        <div id="teacherInfo" class="mb-4 p-3 border rounded bg-light shadow-sm">
                            <div class="row align-items-center">
                                <div class="col-md-3 text-center mb-3 mb-md-0">
                                    <img src="https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9" alt="รูปครู" id="teacherPhoto" class="teacher-photo">
                                </div>
                                <div class="col-md-9">
                                    <p class="mb-1"><strong><i class="fas fa-user me-2"></i>ชื่อ-สกุล:</strong> <span id="teacherName"></span></p>
                                    <p class="mb-1"><strong><i class="fas fa-chalkboard-teacher me-2"></i>กลุ่มสาระฯ:</strong> <span id="teacherDepartment"></span></p>
                                    <p class="mb-0"><strong><i class="fas fa-user-tie me-2"></i>ตำแหน่ง:</strong> <span id="teacherPosition"></span></p>
                                    <input type="hidden" id="hiddenTeacherName" name="teacherName">
                                    <input type="hidden" id="hiddenTeacherDepartment" name="teacherDepartment">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="dutyStatusSection">
                            <label class="form-label fw-bold required-field"><i class="fas fa-clipboard-check me-2 text-primary"></i>สถานะการปฏิบัติงาน</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusPresent" value="มา" required>
                                <label class="form-check-label" for="statusPresent">
                                    <i class="fas fa-user-check text-success me-1"></i> มาปฏิบัติงาน
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusLeave" value="ลา" required>
                                <label class="form-check-label" for="statusLeave">
                                    <i class="fas fa-calendar-times text-warning me-1"></i> ลา
                                </label>
                            </div>
                             <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusOfficialDuty" value="ไปราชการ" required>
                                <label class="form-check-label" for="statusOfficialDuty">
                                     <i class="fas fa-briefcase text-info me-1"></i> ไปราชการ
                                </label>
                            </div>
                             <div id="dutyStatusError" class="invalid-feedback d-block"></div>
                        </div>

                        <div class="mb-3 form-section-hidden" id="dutyTypeSection">
                            <label class="form-label fw-bold required-field"><i class="fas fa-tasks me-2 text-primary"></i>เลือกการปฏิบัติหน้าที่ (สำหรับผู้ที่มา)</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyGate" value="เวรยืนประตู" required>
                                <label class="form-check-label" for="dutyGate">
                                    <i class="fas fa-door-open text-success me-1"></i> เวรยืนประตู
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyBuilding" value="ตรวจอาคาร" required>
                                <label class="form-check-label" for="dutyBuilding">
                                    <i class="fas fa-building text-warning me-1"></i> ตรวจอาคาร
                                </label>
                            </div>
                            <div id="dutyTypeError" class="invalid-feedback d-block"></div>
                        </div>

                         <div class="mb-3 form-section-hidden" id="remarksSection">
                            <label for="remarks" class="form-label fw-bold required-field"><i class="fas fa-edit me-2 text-primary"></i>หมายเหตุ (สำหรับ ลา/ไปราชการ)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3" placeholder="ระบุเหตุผลการลา หรือรายละเอียดการไปราชการ" required></textarea>
                            <div id="remarksError" class="invalid-feedback d-block"></div>
                        </div>

                        <div id="presentFieldsContainer"> <div class="mb-3">
                                <label class="form-label fw-bold required-field"><i class="fas fa-map-marker-alt me-2 text-danger"></i>ตำแหน่งที่ตั้งปัจจุบัน</label>
                                <div id="locationInfo" class="form-control" style="min-height: 40px; background-color: #e9ecef;">
                                    <span class="text-muted">กำลังค้นหาตำแหน่ง...</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1" id="getLocationBtn" title="ลองค้นหาตำแหน่งอีกครั้ง">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="latitude" name="latitude" required>
                                <input type="hidden" id="longitude" name="longitude" required>
                                <div id="locationError" class="invalid-feedback d-block"></div>
                            </div>

                             <div class="mb-3">
                                <label for="signatureCanvas" class="form-label fw-bold required-field"><i class="fas fa-signature me-2 text-success"></i>ลงลายมือชื่อ</label>
                                <div class="signature-pad-container">
                                    <canvas id="signatureCanvas"></canvas>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="resetSignatureBtn"><i class="fas fa-eraser me-1"></i> ล้างลายเซ็น</button>
                                <input type="hidden" id="signatureData" name="signatureData" required>
                                <div id="signatureError" class="invalid-feedback d-block"></div>
                            </div>

                             <div class="mb-4">
                                <label class="form-label fw-bold required-field"><i class="fas fa-camera me-2 text-info"></i>ถ่ายภาพยืนยัน ณ ขณะนั้น</label>
                                <div class="row g-3 align-items-start">
                                    <div class="col-md-6">
                                        <video id="videoFeed" playsinline autoplay muted class="img-fluid border rounded bg-dark"></video>
                                        <canvas id="photoCanvas" style="display:none;"></canvas>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <img id="capturedPhotoPreview" src="https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87" alt="ภาพที่ถ่าย" class="img-fluid border rounded mb-2 captured-photo">
                                        <input type="hidden" id="photoData" name="photoData" required>
                                    </div>
                                </div>
                                <div class="mt-2 text-center btn-group-camera">
                                    <button type="button" class="btn btn-sm btn-info" id="startCameraBtn"><i class="fas fa-video me-1"></i> เปิดกล้อง</button>
                                    <button type="button" class="btn btn-sm btn-success" id="capturePhotoBtn" disabled><i class="fas fa-camera-retro me-1"></i> ถ่ายภาพ</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="resetPhotoBtn" disabled><i class="fas fa-undo me-1"></i> ถ่ายใหม่</button>
                                </div>
                                <div id="cameraError" class="form-text text-danger mt-1 text-center"></div>
                                <div id="photoError" class="invalid-feedback d-block text-center"></div>
                            </div>
                        </div> </div> <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-secondary btn-lg fw-bold shadow" id="submitBtn" disabled>
                           <i class="fas fa-spinner fa-spin me-2"></i> กำลังโหลด...
                        </button>
                    </div>

                    <div id="statusMessage" class="mt-3"></div>

                </form>
            </div>
             <div class="card-footer text-muted text-center small p-2">
                 ระบบลงเวลาปฏิบัติหน้าที่ v2 - โรงเรียนปากช่อง
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzeTu_PKLHpG9tJt3sVhU2GFyrSgkPyhjS5fpCC-ArZ211KFplir4o_1kBaDDXdn4MyMQ/exec'; // <<< ใส่ URL Web App ที่ Deploy แล้ว
            const TEACHER_LOOKUP_URL = SCRIPT_URL + '?action=getTeacherInfo&id=';

            const CHECKIN_START_MINUTE = 7 * 60 + 10; // 07:10 (in minutes from midnight)
            const CHECKIN_END_MINUTE = 10 * 60 + 15; // 08:15 (in minutes from midnight)
            const ALLOWED_DAYS = [1, 2, 3, 4, 5]; // 1=จันทร์, 2=อังคาร, ..., 5=ศุกร์

            // --- DOM ELEMENTS ---
            const clockElement = document.getElementById('clock');
            const checkinForm = document.getElementById('checkinForm');
            const teacherIdInput = document.getElementById('teacherId');
            const teacherLookupStatus = document.getElementById('teacherLookupStatus');
            const mainFormSections = document.getElementById('mainFormSections');
            const teacherInfoDiv = document.getElementById('teacherInfo');
            const teacherPhoto = document.getElementById('teacherPhoto');
            const teacherNameSpan = document.getElementById('teacherName');
            const teacherDepartmentSpan = document.getElementById('teacherDepartment');
            const teacherPositionSpan = document.getElementById('teacherPosition');
            const hiddenTeacherName = document.getElementById('hiddenTeacherName');
            const hiddenTeacherDepartment = document.getElementById('hiddenTeacherDepartment');
            const dutyStatusRadios = document.querySelectorAll('input[name="dutyStatus"]');
            const dutyTypeSection = document.getElementById('dutyTypeSection');
            const dutyTypeRadios = document.querySelectorAll('input[name="dutyType"]');
            const remarksSection = document.getElementById('remarksSection');
            const remarksInput = document.getElementById('remarks');
            const presentFieldsContainer = document.getElementById('presentFieldsContainer'); // Container for fields shown only when 'มา'
            const locationInfoDiv = document.getElementById('locationInfo');
            const getLocationBtn = document.getElementById('getLocationBtn');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const signatureCanvas = document.getElementById('signatureCanvas');
            const resetSignatureBtn = document.getElementById('resetSignatureBtn');
            const signatureDataInput = document.getElementById('signatureData');
            const videoFeed = document.getElementById('videoFeed');
            const photoCanvas = document.getElementById('photoCanvas');
            const capturedPhotoPreview = document.getElementById('capturedPhotoPreview');
            const photoDataInput = document.getElementById('photoData');
            const startCameraBtn = document.getElementById('startCameraBtn');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const resetPhotoBtn = document.getElementById('resetPhotoBtn');
            const submitBtn = document.getElementById('submitBtn');
            const statusMessage = document.getElementById('statusMessage');

            // Error message divs
            const dutyStatusErrorDiv = document.getElementById('dutyStatusError');
            const dutyTypeErrorDiv = document.getElementById('dutyTypeError');
            const remarksErrorDiv = document.getElementById('remarksError');
            const locationErrorDiv = document.getElementById('locationError');
            const signatureErrorDiv = document.getElementById('signatureError');
            const cameraErrorDiv = document.getElementById('cameraError');
            const photoErrorDiv = document.getElementById('photoError');

            // --- STATE VARIABLES ---
            let signaturePad;
            let stream = null;
            let teacherDataCache = null;
            let locationWatcher = null;
            let isSubmitting = false;

            // --- INITIALIZATION ---
            initializeClock();
            initializeSignaturePad();
            initializeGeolocation();
            setInterval(updateClockAndButtonState, 10000); // Update clock and button less frequently (e.g., 10 secs)
            window.addEventListener('resize', resizeCanvas);
            setupEventListeners();

            // --- FUNCTIONS ---

            function setupEventListeners() {
                // Teacher ID input - Auto search on 4 digits
                teacherIdInput.addEventListener('input', handleTeacherIdInput);

                // Duty Status Radio Buttons - Show/hide relevant sections
                dutyStatusRadios.forEach(radio => {
                    radio.addEventListener('change', handleDutyStatusChange);
                });

                // Reset signature button
                resetSignatureBtn.addEventListener('click', () => {
                    if (signaturePad) signaturePad.clear();
                    signatureDataInput.value = '';
                    clearValidationError(signatureErrorDiv);
                });

                 // Geolocation button
                 getLocationBtn.addEventListener('click', initializeGeolocation);

                // Camera buttons
                startCameraBtn.addEventListener('click', startCamera);
                capturePhotoBtn.addEventListener('click', capturePhoto);
                resetPhotoBtn.addEventListener('click', resetPhoto);

                // Form submission
                checkinForm.addEventListener('submit', handleFormSubmit);

                 // Clear errors on input/change
                remarksInput.addEventListener('input', () => clearValidationError(remarksErrorDiv));
                dutyTypeRadios.forEach(radio => radio.addEventListener('change', () => clearValidationError(dutyTypeErrorDiv)));
                signatureCanvas.addEventListener('pointerdown', () => clearValidationError(signatureErrorDiv));
            }

            // 1. Clock & Button State
            function initializeClock() {
                updateClockAndButtonState();
            }

            function updateClockAndButtonState() {
                if (isSubmitting) return;

                const now = new Date();
                const year = now.getFullYear() + 543;
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                const thaiDate = now.toLocaleDateString('th-TH', optionsDate).replace(String(now.getFullYear()), String(year));
                const thaiTime = now.toLocaleTimeString('th-TH', optionsTime);
                clockElement.innerHTML = `<i class="fas fa-clock me-2"></i> ${thaiDate} เวลา ${thaiTime} น.`;

                // Check time and day
                const currentDay = now.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
                const currentMinute = now.getHours() * 60 + now.getMinutes();
                const isAllowedDay = ALLOWED_DAYS.includes(currentDay);
                const isCheckinTime = currentMinute >= CHECKIN_START_MINUTE && currentMinute <= CHECKIN_END_MINUTE;
                const canSubmit = isAllowedDay && isCheckinTime;

                let buttonIconClass = '';
                let buttonText = '';
                let buttonDisabled = true;
                let buttonClass = 'btn btn-secondary btn-lg fw-bold shadow';

                if (canSubmit) {
                    buttonIconClass = 'fas fa-check-circle me-2';
                    buttonText = 'ส่งข้อมูลลงเวลา';
                    buttonDisabled = false; // Enable only if teacher found & valid status selected
                    buttonClass = 'btn btn-primary btn-lg fw-bold shadow';
                } else {
                    buttonIconClass = 'fas fa-times-circle me-2';
                    buttonText = 'นอกช่วงเวลาลงเวลา';
                    if (!isAllowedDay) {
                        buttonText += ' (เฉพาะ จันทร์-ศุกร์)';
                    } else {
                        const startH = String(Math.floor(CHECKIN_START_MINUTE / 60)).padStart(2, '0');
                        const startM = String(CHECKIN_START_MINUTE % 60).padStart(2, '0');
                        const endH = String(Math.floor(CHECKIN_END_MINUTE / 60)).padStart(2, '0');
                        const endM = String(CHECKIN_END_MINUTE % 60).padStart(2, '0');
                        buttonText += ` (${startH}:${startM} - ${endH}:${endM} น.)`;
                    }
                    buttonDisabled = true;
                    buttonClass = 'btn btn-secondary btn-lg fw-bold shadow';
                }

                // Button state also depends on finding a teacher
                submitBtn.disabled = buttonDisabled || !teacherDataCache;
                submitBtn.className = buttonClass;
                submitBtn.innerHTML = `<i class="${buttonIconClass}"></i> ${buttonText}`;
            }

            // 2. Teacher Lookup Logic
            function handleTeacherIdInput() {
                const teacherId = teacherIdInput.value.trim();
                 // Clear previous status and hide main form
                 teacherLookupStatus.textContent = '';
                 mainFormSections.classList.add('form-section-hidden');
                 teacherDataCache = null; // Reset cache
                 updateClockAndButtonState(); // Update button state (will be disabled)
                 resetPartialForm(); // Reset fields below teacher id

                if (teacherId.length === 4) {
                    fetchTeacherData(teacherId);
                } else if (teacherId.length > 4) {
                     teacherIdInput.value = teacherId.slice(0, 4); // Trim extra digits
                }
            }

            async function fetchTeacherData(teacherId) {
                teacherLookupStatus.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> กำลังค้นหา...';
                teacherInfoDiv.style.display = 'none'; // Hide old info box if any
                clearValidationErrors();

                if (SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                     showSweetAlert('error', 'ข้อผิดพลาด', 'กรุณาตั้งค่า URL ของ Apps Script ในโค้ด HTML ก่อน');
                     teacherLookupStatus.textContent = 'ข้อผิดพลาดในการตั้งค่า';
                     return;
                 }

                try {
                    const lookupUrl = `${TEACHER_LOOKUP_URL}${encodeURIComponent(teacherId)}`;
                    const response = await fetch(lookupUrl);

                    if (!response.ok) throw new Error(`ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ (Status: ${response.status})`);

                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        const textResponse = await response.text();
                        console.error("Received non-JSON response:", textResponse);
                        throw new Error("เซิร์ฟเวอร์ไม่ได้ตอบกลับเป็น JSON");
                    }

                    const data = await response.json();

                    if (data.status === 'error') throw new Error(data.message || 'ข้อผิดพลาดจาก Apps Script');
                    if (data.found && data.teacher) {
                        teacherDataCache = data.teacher;
                        teacherNameSpan.textContent = data.teacher.name || 'N/A';
                        teacherDepartmentSpan.textContent = data.teacher.department || 'N/A';
                        teacherPositionSpan.textContent = data.teacher.position || 'N/A';
                        teacherPhoto.src = data.teacher.photoUrl || 'https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9';
                        teacherPhoto.alt = `รูปภาพ ${data.teacher.name || 'ครู'}`;
                        hiddenTeacherName.value = data.teacher.name || '';
                        hiddenTeacherDepartment.value = data.teacher.department || '';

                        teacherInfoDiv.style.display = 'block'; // Show the info box
                        mainFormSections.classList.remove('form-section-hidden'); // Show the rest of the form
                        teacherLookupStatus.textContent = '';
                         showSweetAlert('success', 'พบข้อมูลครู', `ชื่อ: ${data.teacher.name || 'N/A'}`);
                         updateClockAndButtonState(); // Re-evaluate button state now that teacher is found

                    } else {
                        throw new Error(data.message || 'ไม่พบข้อมูลครูสำหรับรหัสนี้');
                    }
                } catch (error) {
                    console.error('Error fetching teacher data:', error);
                    showSweetAlert('error', 'ค้นหาไม่สำเร็จ', error.message);
                    teacherLookupStatus.textContent = `ข้อผิดพลาด: ${error.message}`;
                    mainFormSections.classList.add('form-section-hidden'); // Hide form again
                    teacherDataCache = null;
                     updateClockAndButtonState();
                }
            }

             // 3. Duty Status Change Handler
            function handleDutyStatusChange() {
                const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked');
                clearValidationError(dutyStatusErrorDiv); // Clear status error

                 // Reset dependent sections first
                 dutyTypeSection.classList.add('form-section-hidden');
                 remarksSection.classList.add('form-section-hidden');
                 presentFieldsContainer.classList.add('form-section-hidden'); // Hide fields like signature, photo etc. initially
                 // Clear values and errors in hidden sections
                 dutyTypeRadios.forEach(r => r.checked = false);
                 remarksInput.value = '';
                 clearValidationError(dutyTypeErrorDiv);
                 clearValidationError(remarksErrorDiv);


                if (selectedStatus) {
                    const statusValue = selectedStatus.value;
                    if (statusValue === 'มา') {
                        dutyTypeSection.classList.remove('form-section-hidden');
                         presentFieldsContainer.classList.remove('form-section-hidden'); // Show signature, photo etc.
                         // Make fields inside presentFieldsContainer required
                         setRequiredStatus(presentFieldsContainer, true);
                         // Make remarks not required
                         setRequiredStatus(remarksSection, false);
                         remarksInput.required = false;
                         // Make duty type required
                         dutyTypeRadios.forEach(r => r.required = true);


                    } else if (statusValue === 'ลา' || statusValue === 'ไปราชการ') {
                        remarksSection.classList.remove('form-section-hidden');
                         // Make fields inside presentFieldsContainer NOT required
                         setRequiredStatus(presentFieldsContainer, false);
                         // Make remarks required
                         setRequiredStatus(remarksSection, true);
                         remarksInput.required = true;
                         // Make duty type not required
                         dutyTypeRadios.forEach(r => r.required = false);
                         dutyTypeRadios.forEach(r => r.checked = false); // Uncheck duty type


                         // Stop camera if running when switching to La/Official Duty
                         stopCameraStream();
                         resetPhotoState(); // Reset preview etc.

                    }
                } else {
                     // No status selected yet, hide everything dependent
                      setRequiredStatus(presentFieldsContainer, false);
                      setRequiredStatus(remarksSection, false);
                      remarksInput.required = false;
                      dutyTypeRadios.forEach(r => r.required = false);
                 }
            }

            // Helper to set required attribute on inputs within a container
            function setRequiredStatus(container, isRequired) {
                 container.querySelectorAll('input[type="text"], input[type="hidden"], input[type="radio"], textarea').forEach(input => {
                    // Only toggle required for elements that *can* be required based on status
                    // We handle radio groups slightly differently in validation
                    if (input.type !== 'radio' && input.id !== 'hiddenTeacherName' && input.id !== 'hiddenTeacherDepartment') { // Exclude hidden teacher info
                         input.required = isRequired;
                    }
                 });
                 // Specific handling for dutyType radio group required attribute
                  if (container.id === 'dutyTypeSection') {
                      dutyTypeRadios.forEach(r => r.required = isRequired);
                  }
             }


            // 4. Geolocation
            function initializeGeolocation() {
                 locationInfoDiv.querySelector('span').innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> กำลังค้นหา...';
                 clearValidationError(locationErrorDiv);
                 latitudeInput.value = '';
                 longitudeInput.value = '';

                 if ('geolocation' in navigator) {
                     if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                     navigator.geolocation.getCurrentPosition(
                         (position) => {
                             const lat = position.coords.latitude;
                             const lon = position.coords.longitude;
                             latitudeInput.value = lat;
                             longitudeInput.value = lon;
                             locationInfoDiv.querySelector('span').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                             const mapLinkUrl = `https://www.google.com/maps?q=$${lat},${lon}`;
                             let mapLink = locationInfoDiv.querySelector('a');
                             if (!mapLink) {
                                 mapLink = document.createElement('a');
                                 mapLink.target = '_blank';
                                 mapLink.rel = 'noopener noreferrer';
                                 mapLink.classList.add('ms-2', 'small');
                                 mapLink.innerHTML = '<i class="fas fa-external-link-alt"></i> ดูแผนที่';
                                 locationInfoDiv.appendChild(mapLink);
                             }
                             mapLink.href = mapLinkUrl;
                         },
                         handleLocationError,
                         { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                     );
                 } else {
                     handleLocationError({ code: -1, message: 'เบราว์เซอร์ไม่รองรับ Geolocation' });
                 }
             }

             function handleLocationError(error) {
                 console.error('Geolocation error:', error);
                 let message = 'ไม่สามารถรับตำแหน่งได้: ';
                 switch (error.code) {
                     case error.PERMISSION_DENIED: message += 'ผู้ใช้ปฏิเสธการเข้าถึงตำแหน่ง'; break;
                     case error.POSITION_UNAVAILABLE: message += 'ข้อมูลตำแหน่งไม่พร้อมใช้งาน'; break;
                     case error.TIMEOUT: message += 'หมดเวลาในการค้นหาตำแหน่ง'; break;
                     case -1: message = error.message; break; // Custom code
                     default: message += 'เกิดข้อผิดพลาดที่ไม่รู้จัก'; break;
                 }
                  locationInfoDiv.querySelector('span').textContent = 'ข้อผิดพลาด';
                  showError(locationErrorDiv, message);
                  latitudeInput.value = '';
                  longitudeInput.value = '';
             }

            // 5. Signature Pad
            function initializeSignaturePad() {
                 resizeCanvas();
                 signaturePad = new SignaturePad(signatureCanvas, {
                     backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)'
                 });
            }

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                const canvasContainer = signatureCanvas.parentElement;
                if (!canvasContainer || canvasContainer.offsetWidth === 0) return;
                signatureCanvas.width = canvasContainer.offsetWidth * ratio;
                signatureCanvas.height = canvasContainer.offsetHeight * ratio;
                signatureCanvas.getContext("2d").scale(ratio, ratio);
                if (signaturePad) signaturePad.clear();
            }

            // 6. Camera Functionality
             function stopCameraStream() {
                 if (stream) {
                     stream.getTracks().forEach(track => track.stop());
                     stream = null;
                     videoFeed.srcObject = null;
                     console.log("Camera stream stopped.");
                 }
                 // Reset button states related to camera
                 capturePhotoBtn.disabled = true;
                 resetPhotoBtn.disabled = true;
                 startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                 // Hide video feed if stopped explicitly
                 videoFeed.style.display = 'none';

            }

            function resetPhotoState() {
                 // Reset preview image
                capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';
                capturedPhotoPreview.alt = 'ภาพตัวอย่าง';
                 // Clear hidden data
                photoDataInput.value = '';
                 // Clear canvas
                 if(photoCanvas) {
                    const context = photoCanvas.getContext('2d');
                    if (context) context.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
                 }
                // Reset buttons
                 capturePhotoBtn.disabled = true; // Disabled until camera is started again
                 resetPhotoBtn.disabled = true;
                 startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                  videoFeed.style.display = 'none'; // Ensure video feed is hidden
                  clearValidationError(photoErrorDiv);
                  clearValidationError(cameraErrorDiv);
            }

            async function startCamera() {
                 clearValidationError(cameraErrorDiv);
                 clearValidationError(photoErrorDiv);
                 stopCameraStream(); // Stop existing stream first
                 await new Promise(resolve => setTimeout(resolve, 100)); // Short delay

                 try {
                     console.log("Requesting camera access...");
                     stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                     console.log("Camera access granted.");
                     videoFeed.srcObject = stream;
                     videoFeed.style.display = 'block';
                     capturePhotoBtn.disabled = false; // Enable capture button
                     resetPhotoBtn.disabled = true; // Disable reset until photo taken
                     startCameraBtn.innerHTML = '<i class="fas fa-sync me-1"></i> รีสตาร์ทกล้อง';
                     // Reset preview to placeholder when starting camera
                    capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E';
                    capturedPhotoPreview.alt = 'กดปุ่มถ่ายภาพ';
                    photoDataInput.value = ''; // Clear old photo data

                 } catch (err) {
                     console.error("Camera Error:", err.name, err.message);
                     let errorMsg = `ไม่สามารถเข้าถึงกล้องได้: ${err.name}`;
                     if (err.name === "NotReadableError") errorMsg += " - กล้องอาจถูกใช้โดยโปรแกรมอื่น";
                     else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") errorMsg += " - ไม่พบอุปกรณ์กล้อง";
                     else if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") errorMsg += " - กรุณาอนุญาตให้เข้าถึงกล้อง";
                     else errorMsg += ` (${err.message})`;
                     showError(cameraErrorDiv, errorMsg);
                     capturePhotoBtn.disabled = true;
                     resetPhotoBtn.disabled = true;
                     startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> เปิดกล้อง';
                      videoFeed.style.display = 'none'; // Hide video feed on error
                     stopCameraStream(); // Ensure stream stopped on error
                 }
             }

             function capturePhoto() {
                 if (!stream || !stream.active) {
                     showError(cameraErrorDiv, 'กรุณาเปิดกล้องก่อนถ่ายภาพ');
                     return;
                 }
                 clearValidationError(photoErrorDiv);

                 const videoWidth = videoFeed.videoWidth;
                 const videoHeight = videoFeed.videoHeight;
                 if (!videoWidth || !videoHeight) {
                    showError(cameraErrorDiv, 'ไม่สามารถอ่านขนาดวิดีโอได้');
                    return;
                 }
                 photoCanvas.width = videoWidth;
                 photoCanvas.height = videoHeight;
                 const context = photoCanvas.getContext('2d');
                 context.drawImage(videoFeed, 0, 0, videoWidth, videoHeight);
                 const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.85);
                 capturedPhotoPreview.src = dataUrl;
                 capturedPhotoPreview.alt = 'ภาพที่ถ่าย';
                 photoDataInput.value = dataUrl.split(',')[1];

                 resetPhotoBtn.disabled = false; // Enable reset button
                 capturePhotoBtn.disabled = true; // Disable capture button
                 // Optional: Stop camera after capture
                 // stopCameraStream();
             }

             function resetPhoto() {
                 clearValidationError(photoErrorDiv);
                 if (!stream || !stream.active) {
                      resetPhotoState(); // Reset preview etc. if stream already stopped
                     // Optionally call startCamera() again if needed
                 } else {
                    // If stream is active, just clear the preview and enable capture
                     capturedPhotoPreview.src = 'https://placehold.co/300x240/e9ecef/6c757d?text=%E0%B8%81%E0%B8%94%E0%B8%96%E0%B9%88%E0%B8%B2%E0%B8%A2%E0%B8%A0%E0%B8%B2%E0%B8%9E';
                     capturedPhotoPreview.alt = 'กดปุ่มถ่ายภาพ';
                     photoDataInput.value = '';
                     const context = photoCanvas.getContext('2d');
                     if (context) context.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
                     resetPhotoBtn.disabled = true; // Disable reset
                     capturePhotoBtn.disabled = false; // Enable capture
                 }
             }

            // 7. Form Validation
            function validateForm() {
                 clearValidationErrors(); // Clear previous errors
                 let isValid = true;
                 const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');

                 // a. Check Teacher ID and successful lookup
                 if (!teacherIdInput.value || teacherIdInput.value.length !== 4) {
                     showError(teacherLookupStatus, 'กรุณากรอกรหัสครู 4 หลัก');
                     isValid = false;
                 } else if (!teacherDataCache) {
                     showError(teacherLookupStatus, 'กรุณากดค้นหาข้อมูลครู หรือรหัสไม่ถูกต้อง');
                     isValid = false;
                 }

                 // b. Check Duty Status selection
                 if (!selectedStatusRadio) {
                     showError(dutyStatusErrorDiv, 'กรุณาเลือกสถานะการปฏิบัติงาน');
                     isValid = false;
                     return isValid; // Stop validation if status not selected
                 }

                 const selectedStatus = selectedStatusRadio.value;

                 if (selectedStatus === 'มา') {
                     // c. Check Duty Type (if 'มา')
                     const selectedDutyType = document.querySelector('input[name="dutyType"]:checked');
                     if (!selectedDutyType) {
                         showError(dutyTypeErrorDiv, 'กรุณาเลือกการปฏิบัติหน้าที่');
                         isValid = false;
                     }
                     // d. Check Location (if 'มา')
                     if (!latitudeInput.value || !longitudeInput.value) {
                         showError(locationErrorDiv, 'ไม่สามารถระบุตำแหน่งได้ กรุณาลองกดปุ่มรีเฟรชตำแหน่ง');
                         isValid = false;
                     }
                     // e. Check Signature (if 'มา')
                     if (signaturePad && signaturePad.isEmpty()) {
                         showError(signatureErrorDiv, 'กรุณาลงลายมือชื่อ');
                         isValid = false;
                     }
                     // f. Check Photo (if 'มา')
                     if (!photoDataInput.value) {
                         showError(photoErrorDiv, 'กรุณาถ่ายภาพยืนยัน');
                         isValid = false;
                     }
                 } else { // Status is 'ลา' or 'ไปราชการ'
                     // g. Check Remarks (if 'ลา' or 'ไปราชการ')
                      if (!remarksInput.value.trim()) {
                         showError(remarksErrorDiv, 'กรุณาระบุหมายเหตุ');
                         isValid = false;
                     }
                 }

                // h. Check Time and Day again right before submit
                 const now = new Date();
                 const currentDay = now.getDay();
                 const currentMinute = now.getHours() * 60 + now.getMinutes();
                 const isAllowedDay = ALLOWED_DAYS.includes(currentDay);
                 const isCheckinTime = currentMinute >= CHECKIN_START_MINUTE && currentMinute <= CHECKIN_END_MINUTE;

                 if (!(isAllowedDay && isCheckinTime)) {
                     const startH = String(Math.floor(CHECKIN_START_MINUTE / 60)).padStart(2, '0');
                     const startM = String(CHECKIN_START_MINUTE % 60).padStart(2, '0');
                     const endH = String(Math.floor(CHECKIN_END_MINUTE / 60)).padStart(2, '0');
                     const endM = String(CHECKIN_END_MINUTE % 60).padStart(2, '0');
                     const timeMsg = `ไม่อยู่ในช่วงเวลาที่กำหนด (ลงเวลาเฉพาะวันจันทร์-ศุกร์ ตั้งแต่เวลา ${startH}:${startM} - ${endH}:${endM} น.)`;
                     showSweetAlert('warning', 'นอกช่วงเวลา', timeMsg);
                     isValid = false;
                 }

                 return isValid;
             }

             function clearValidationErrors() {
                 const errorDivs = [
                     teacherLookupStatus, dutyStatusErrorDiv, dutyTypeErrorDiv, remarksErrorDiv,
                     locationErrorDiv, signatureErrorDiv, cameraErrorDiv, photoErrorDiv
                 ];
                 errorDivs.forEach(div => { if (div) div.textContent = ''; });
                 statusMessage.innerHTML = '';
             }
              function clearValidationError(errorDiv) {
                 if (errorDiv) errorDiv.textContent = '';
             }
             function showError(errorDiv, message) {
                  if(errorDiv) errorDiv.textContent = message;
                  errorDiv.classList.add('text-danger'); // Ensure it's red
             }


            // 8. Form Submission Handler
            async function handleFormSubmit(e) {
                 e.preventDefault();
                 clearValidationErrors();

                 if (!validateForm()) {
                      // Validation function already shows errors and SweetAlert for time issues
                     // Scroll to the first error message
                      const firstError = checkinForm.querySelector('.text-danger:not(:empty)');
                     if (firstError) {
                         firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     }
                     return;
                 }

                  if (SCRIPT_URL === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
                     showSweetAlert('error', 'ข้อผิดพลาด', 'กรุณาตั้งค่า URL ของ Apps Script ในโค้ด HTML ก่อน');
                     return;
                 }

                 isSubmitting = true;
                 submitBtn.disabled = true;
                 submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> กำลังส่งข้อมูล...';
                 statusMessage.innerHTML = '';

                 const formData = new FormData(checkinForm);
                 const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked').value;

                 // Ensure signature/photo data is added only if 'มา'
                 if (selectedStatus === 'มา') {
                     if (signaturePad && !signaturePad.isEmpty()) {
                         const sigDataUrl = signaturePad.toDataURL('image/jpeg', 0.85);
                         formData.set('signatureData', sigDataUrl.split(',')[1]);
                     } else {
                          formData.delete('signatureData'); // Remove if empty (should be caught by validation, but safety check)
                     }
                      if (!photoDataInput.value) {
                          formData.delete('photoData'); // Remove if empty
                      }
                 } else {
                     // If not 'มา', remove signature and photo data explicitly
                     formData.delete('signatureData');
                     formData.delete('photoData');
                      formData.delete('dutyType'); // Also remove dutyType if not 'มา'
                 }

                 // Add client timestamp
                 formData.append('clientTimestamp', new Date().toISOString());

                // Debug: Log FormData content before sending
                // for (let [key, value] of formData.entries()) {
                //     console.log(`${key}: ${value.length > 100 ? value.substring(0,100) + '...' : value}`);
                // }


                 try {
                     const response = await fetch(SCRIPT_URL, {
                         method: 'POST',
                         body: formData,
                     });

                     const contentType = response.headers.get("content-type");
                     let result;
                     if (contentType && contentType.includes("application/json")) {
                         result = await response.json();
                     } else {
                         const textResponse = await response.text();
                         console.error("Server returned non-JSON response:", textResponse);
                         throw new Error(textResponse || `เกิดข้อผิดพลาดจากเซิร์ฟเวอร์ (Status: ${response.status})`);
                     }

                     if (result.status === 'success') {
                          showSuccessSweetAlert(result); // Show detailed success alert
                         resetFullForm();
                     } else {
                         throw new Error(result.message || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุจากเซิร์ฟเวอร์');
                     }

                 } catch (error) {
                     console.error('Error submitting form:', error);
                     showSweetAlert('error', 'ส่งข้อมูลไม่สำเร็จ', `เกิดข้อผิดพลาด: ${error.message}`);
                 } finally {
                     isSubmitting = false;
                     updateClockAndButtonState(); // Update button based on current time/day
                 }
            }

            // 9. Utility Functions
             function showSweetAlert(icon, title, text) {
                Swal.fire({ icon: icon, title: title, text: text, confirmButtonText: 'ปิด' });
             }

             function showSuccessSweetAlert(data) {
                 let htmlContent = `
                     <p><strong>วันที่/เวลา:</strong> ${data.checkinTime || 'N/A'}</p>
                     <p><strong>ชื่อ-สกุล:</strong> ${data.teacherName || 'N/A'}</p>
                 `;
                 // Only show photo if status was 'มา' (photoUrl will exist)
                 if (data.photoUrl) {
                     htmlContent += `<img src="${data.photoUrl}" alt="รูปเช็คอิน" class="swal2-image">`;
                 } else {
                     // Indicate if status was 'ลา' or 'ไปราชการ'
                     const statusRadio = document.querySelector('input[name="dutyStatus"]:checked');
                     if (statusRadio) {
                          htmlContent += `<p><strong>สถานะ:</strong> ${statusRadio.value}</p>`;
                           if (statusRadio.value !== 'มา' && remarksInput.value) {
                               htmlContent += `<p><strong>หมายเหตุ:</strong> ${remarksInput.value}</p>`;
                           }
                     }
                 }


                 Swal.fire({
                     icon: 'success',
                     title: 'บันทึกข้อมูลสำเร็จ!',
                     html: htmlContent,
                     confirmButtonText: 'ปิด'
                 });
             }

             // Resets fields below teacher ID, keeping teacher ID and info displayed
             function resetPartialForm() {
                 // Reset status selection
                 dutyStatusRadios.forEach(radio => radio.checked = false);
                 // Hide dependent sections
                 dutyTypeSection.classList.add('form-section-hidden');
                 remarksSection.classList.add('form-section-hidden');
                 presentFieldsContainer.classList.add('form-section-hidden');
                 // Clear values in these sections
                 dutyTypeRadios.forEach(radio => radio.checked = false);
                 remarksInput.value = '';
                 if(signaturePad) signaturePad.clear();
                 signatureDataInput.value = '';
                 resetPhotoState(); // Reset camera preview and data
                 stopCameraStream(); // Ensure camera is stopped
                 latitudeInput.value = '';
                 longitudeInput.value = '';
                 locationInfoDiv.querySelector('span').textContent = 'ตำแหน่งจะแสดงที่นี่';
                 const mapLink = locationInfoDiv.querySelector('a');
                 if (mapLink) mapLink.remove();
                 initializeGeolocation(); // Try to get location again
                 clearValidationErrors(); // Clear errors in reset fields
             }


             function resetFullForm() {
                 checkinForm.reset(); // Standard form reset
                 if (signaturePad) signaturePad.clear();
                 resetPhotoState(); // Resets camera preview, data, buttons
                 stopCameraStream(); // Ensure camera is fully stopped
                 // Hide sections that depend on teacher lookup and status
                 mainFormSections.classList.add('form-section-hidden');
                 dutyTypeSection.classList.add('form-section-hidden');
                 remarksSection.classList.add('form-section-hidden');
                 presentFieldsContainer.classList.add('form-section-hidden');
                 // Clear teacher info display
                 teacherInfoDiv.style.display = 'none';
                 teacherPhoto.src = 'https://placehold.co/120x120/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9';
                 teacherNameSpan.textContent = '';
                 teacherDepartmentSpan.textContent = '';
                 teacherPositionSpan.textContent = '';
                 hiddenTeacherName.value = '';
                 hiddenTeacherDepartment.value = '';
                 // Clear state variables
                 teacherIdInput.value = ''; // Clear the ID input itself
                 teacherDataCache = null;
                 latitudeInput.value = '';
                 longitudeInput.value = '';
                 locationInfoDiv.querySelector('span').textContent = 'ตำแหน่งจะแสดงที่นี่';
                 const mapLink = locationInfoDiv.querySelector('a');
                 if (mapLink) mapLink.remove();
                 initializeGeolocation();
                 clearValidationErrors();
                 updateClockAndButtonState(); // Update button state
                 window.scrollTo({ top: 0, behavior: 'smooth' });
             }

        }); // End DOMContentLoaded
    </script>

</body>
</html>
